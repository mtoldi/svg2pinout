<!DOCTYPE html>
<html>
<head>
  <title>SVG Composer</title>
  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
  <style>
    body {
      font-family: 'Source Code Pro', monospace;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #navbar {
      background: #333;
      color: white;
      padding: 10px 20px;
      display: flex;
      gap: 20px;
      align-items: center;
    }

    #navbar a {
      color: white;
      text-decoration: none;
      font-weight: bold;
      font-size: 0.95rem;
    }

    #navbar a.active {
      background-color: #555;
      padding: 6px 12px;
      border-radius: 5px;
    }

    #composer-toolbar {
      background: #f4f4f4;
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      border-bottom: 1px solid #ccc;
    }

    #composer-area {
      flex: 1;
      background: white;
      position: relative;
      overflow: hidden;
    }

    #composer-area svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    #graphics-svg {
      pointer-events: auto;
    }

    #user-svg {
      pointer-events: none;
    }
  </style>
</head>
<body>

<div id="navbar">
  <a href="/kicad">KiCad Layers</a>
  <a href="/editor-upload">SVG Pin Editor</a>
  <a href="/composer" class="active">SVG to PDF</a>
</div>

<div id="composer-toolbar">
  <input type="file" id="svg-upload" accept=".svg">
  <button onclick="rotateSVG()">Rotiraj +90°</button>
  <button onclick="centerSVG()">Centriraj</button>
  <button onclick="exportAsPDF()">Export to PDF</button>
  <button id="switch-layer">Layer: GRAPHICS</button>
</div>

<div id="composer-area">
  <svg id="graphics-svg" xmlns="http://www.w3.org/2000/svg">
    <g id="graphics-layer"></g>
  </svg>
  <svg id="user-svg" xmlns="http://www.w3.org/2000/svg">
    <g id="user-layer"></g>
  </svg>
</div>

<script>
  const graphicsSVG = document.getElementById("graphics-svg");
  const graphicsLayer = document.getElementById("graphics-layer");
  const userSVG = document.getElementById("user-svg");
  const userLayer = document.getElementById("user-layer");
  const switchButton = document.getElementById("switch-layer");

  let currentLayer = "graphics";
  let panZoomInstance = null;
  let currentRotation = 0;

  function updateLayerMode() {
    if (currentLayer === "graphics") {
      graphicsSVG.style.pointerEvents = "auto";
      userSVG.style.pointerEvents = "none";
      switchButton.textContent = "Layer: GRAPHICS";
    } else {
      graphicsSVG.style.pointerEvents = "none";
      userSVG.style.pointerEvents = "auto";
      switchButton.textContent = "Layer: USER";
    }
  }

  switchButton.addEventListener("click", () => {
    currentLayer = currentLayer === "graphics" ? "user" : "graphics";
    updateLayerMode();
  });

  updateLayerMode(); // inicializacija

  document.getElementById('svg-upload').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file || !file.name.endsWith('.svg')) return;

    const reader = new FileReader();
    reader.onload = function(event) {
  const tempContainer = document.createElement("div");
  tempContainer.innerHTML = event.target.result;
  const incomingSVG = tempContainer.querySelector("svg");
  if (!incomingSVG) return;

  // Ukloni sve prethodne stvari iz user-layer
  userLayer.innerHTML = "";

  // Kopiraj sve child elemente iz učitanog SVG-a u user-layer
  while (incomingSVG.childNodes.length > 0) {
    userLayer.appendChild(incomingSVG.childNodes[0]);
  }

  // Ako originalni SVG ima viewBox – preuzmi ga
  if (incomingSVG.hasAttribute("viewBox")) {
    userSVG.setAttribute("viewBox", incomingSVG.getAttribute("viewBox"));
  }

  // Resetiraj rotaciju
  currentRotation = 0;

  // Aktiviraj pan-zoom nad userSVG
  if (panZoomInstance) panZoomInstance.destroy();
  panZoomInstance = svgPanZoom(userSVG, {
    zoomEnabled: true,
    controlIconsEnabled: false,
    fit: true,
    center: true,
    minZoom: 0.0001,
    maxZoom: 1000,
    zoomScaleSensitivity: 0.2,
    panEnabled: true,
    dblClickZoomEnabled: true,
    mouseWheelZoomEnabled: true
  });
};

    reader.readAsText(file);
  });


  function centerSVG() {
    const g = userLayer.querySelector("#main-content");
    if (!g) return;
    
    const bbox = g.getBBox();
    
    const padding = 50; // ili više ako treba
    
    const x = bbox.x - padding;
    const y = bbox.y - padding;
    const width = bbox.width + padding * 2;
    const height = bbox.height + padding * 2;
    
    userSVG.setAttribute("viewBox", `${x} ${y} ${width} ${height}`);
    
    if (panZoomInstance) {
      panZoomInstance.resize();
      panZoomInstance.fit();
    }
  }


  function rotateSVG() {
    const g = userLayer.querySelector("#main-content");
    if (!g) return;

    currentRotation = (currentRotation + 90) % 360;

    const bbox = g.getBBox();
    const cx = bbox.x + bbox.width / 2;
    const cy = bbox.y + bbox.height / 2;

    g.setAttribute("transform", `rotate(${currentRotation} ${cx} ${cy})`);

    centerSVG();
  }

  function exportAsPDF() {
    const exportSVG = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    exportSVG.setAttribute("xmlns", "http://www.w3.org/2000/svg");
    exportSVG.setAttribute("width", "1000");
    exportSVG.setAttribute("height", "1000");

    const graphicsClone = graphicsLayer.cloneNode(true);
    const userClone = userLayer.cloneNode(true);

    exportSVG.appendChild(graphicsClone);
    exportSVG.appendChild(userClone);

    const svgString = new XMLSerializer().serializeToString(exportSVG);
    const blob = new Blob([svgString], { type: "image/svg+xml" });
    const url = URL.createObjectURL(blob);

    const link = document.createElement("a");
    link.href = url;
    link.download = "composed.svg";
    link.click();
    URL.revokeObjectURL(url);
  }
</script>

</body>
</html>
