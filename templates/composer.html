<!DOCTYPE html>
<html>
<head>
  <title>SVG Composer</title>
  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
  <style>
    body {
      font-family: 'Source Code Pro', monospace;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #navbar {
      background: #333;
      color: white;
      padding: 10px 20px;
      display: flex;
      gap: 20px;
      align-items: center;
    }

    #navbar a {
      color: white;
      text-decoration: none;
      font-weight: bold;
      font-size: 0.95rem;
    }

    #navbar a.active {
      background-color: #555;
      padding: 6px 12px;
      border-radius: 5px;
    }

    #composer-toolbar {
      background: #f4f4f4;
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      border-bottom: 1px solid #ccc;
    }

    #composer-area {
      flex: 1;
      background: white;
      position: relative;
      overflow: hidden;
    }

    #composer-area svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    #graphics-svg {
      pointer-events: auto;
    }

    #user-svg {
      pointer-events: none;
    }
  </style>
</head>
<body>

<div id="navbar">
  <a href="/kicad">KiCad Layers</a>
  <a href="/editor-upload">SVG Pin Editor</a>
  <a href="/composer" class="active">SVG to PDF</a>
</div>

<div id="composer-toolbar">
  <input type="file" id="svg-upload" accept=".svg">
  <button onclick="rotateSVG()">Rotiraj +90°</button>
  <button onclick="centerSVG()">Centriraj</button>

  <button onclick="downloadCurrentViewportAsSVG()">Export Viewport SVG</button>
  <button id="switch-layer">Layer: GRAPHICS</button>

  <input type="text" id="title-input" placeholder="Upiši naziv (npr. DasDuino Core)" style="flex: 1; max-width: 300px;">
  <button onclick="addTitleBox()">Dodaj naslov</button>

</div>

<div id="composer-area">
  <svg id="graphics-svg" xmlns="http://www.w3.org/2000/svg">
    <g id="graphics-layer"></g>
  </svg>
  <svg id="user-svg" xmlns="http://www.w3.org/2000/svg">
    <g id="user-layer"></g>
  </svg>
</div>

<script>
  const graphicsSVG = document.getElementById("graphics-svg");
  const graphicsLayer = document.getElementById("graphics-layer");
  const userSVG = document.getElementById("user-svg");
  const userLayer = document.getElementById("user-layer");
  const switchButton = document.getElementById("switch-layer");

  let currentLayer = "graphics";
  let panZoomInstance = null;
  let currentRotation = 0;

  function updateLayerMode() {
    if (currentLayer === "graphics") {
      graphicsSVG.style.pointerEvents = "auto";
      userSVG.style.pointerEvents = "none";
      switchButton.textContent = "Layer: GRAPHICS";
    } else {
      graphicsSVG.style.pointerEvents = "none";
      userSVG.style.pointerEvents = "auto";
      switchButton.textContent = "Layer: USER";
    }
  }

  switchButton.addEventListener("click", () => {
    currentLayer = currentLayer === "graphics" ? "user" : "graphics";
    updateLayerMode();
  });

  updateLayerMode(); // inicializacija

  document.getElementById('svg-upload').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file || !file.name.endsWith('.svg')) return;

    const reader = new FileReader();
    reader.onload = function(event) {
  const tempContainer = document.createElement("div");
  tempContainer.innerHTML = event.target.result;
  const incomingSVG = tempContainer.querySelector("svg");
  if (!incomingSVG) return;

  // Ukloni sve prethodne stvari iz user-layer
  userLayer.innerHTML = "";

  // Kopiraj sve child elemente iz učitanog SVG-a u user-layer
  while (incomingSVG.childNodes.length > 0) {
    userLayer.appendChild(incomingSVG.childNodes[0]);
  }

  // Ako originalni SVG ima viewBox – preuzmi ga
  if (incomingSVG.hasAttribute("viewBox")) {
    userSVG.setAttribute("viewBox", incomingSVG.getAttribute("viewBox"));
  }

  // Resetiraj rotaciju
  currentRotation = 0;

  // Aktiviraj pan-zoom nad userSVG
  if (panZoomInstance) panZoomInstance.destroy();
  panZoomInstance = svgPanZoom(userSVG, {
    zoomEnabled: true,
    controlIconsEnabled: false,
    fit: true,
    center: true,
    minZoom: 0.0001,
    maxZoom: 1000,
    zoomScaleSensitivity: 0.2,
    panEnabled: true,
    dblClickZoomEnabled: true,
    mouseWheelZoomEnabled: true
  });
};

    reader.readAsText(file);
  });

function rotateSVG() {
  const g = userLayer.querySelector("#main-content");
  if (!g) return;

  currentRotation = (currentRotation + 90) % 360;

  // Prvo primijeni rotaciju
  const bboxBefore = g.getBBox(); // referenca prije da znamo centar
  const cx = bboxBefore.x + bboxBefore.width / 2;
  const cy = bboxBefore.y + bboxBefore.height / 2;

  g.setAttribute("transform", `rotate(${currentRotation} ${cx} ${cy})`);

  // ⚠️ Sačekaj jedan frame da browser izračuna novi bounding box
  requestAnimationFrame(() => centerSVG());
}

function centerSVG() {
  const g = userLayer.querySelector("#main-content");
  if (!g) return;

  const bbox = g.getBBox(); // dobiva dimenzije sadržaja

  const padding = 50;

  const svgWidth = userSVG.clientWidth;
  const svgHeight = userSVG.clientHeight;
  const svgAspect = svgWidth / svgHeight;

  const contentWidth = bbox.width + padding * 2;
  const contentHeight = bbox.height + padding * 2;
  const contentAspect = contentWidth / contentHeight;

  let viewBoxX = bbox.x - padding;
  let viewBoxY = bbox.y - padding;
  let viewBoxWidth = contentWidth;
  let viewBoxHeight = contentHeight;

  // Ako je sadržaj "širi" od prozora, proširi viewBox na visinu
  if (contentAspect > svgAspect) {
    const idealHeight = contentWidth / svgAspect;
    const extra = idealHeight - contentHeight;
    viewBoxY -= extra / 2;
    viewBoxHeight = idealHeight;
  } else {
    // Inače proširi širinu
    const idealWidth = contentHeight * svgAspect;
    const extra = idealWidth - contentWidth;
    viewBoxX -= extra / 2;
    viewBoxWidth = idealWidth;
  }

  userSVG.setAttribute("viewBox", `${viewBoxX} ${viewBoxY} ${viewBoxWidth} ${viewBoxHeight}`);

  if (panZoomInstance) {
    panZoomInstance.resize();
    panZoomInstance.fit();
  }
}





function addTitleBox() {
  const titleInput = document.getElementById("title-input");
  const rawText = titleInput.value.trim();
  if (!rawText) return;

  const title = rawText.toUpperCase();
  const fullText = `${title} - Pinout`;

  const group = document.createElementNS("http://www.w3.org/2000/svg", "g");

  // Dimenzije pravokutnika
  const x = 100;
  const y = 100;
  const width = 600;  // duplo duži
  const height = 50;  // manja visina
  const cut = 10;     // veličina odrezanog kuta

  // Glavni pravokutnik s odrezanim DONJIM lijevim kutom
  const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
  path.setAttribute("d", `
    M${x},${y} 
    H${x + width} 
    V${y + height} 
    H${x + cut} 
    L${x},${y + height - cut} 
    Z
  `);
  path.setAttribute("fill", "#500B76");

  // Tekst centriran unutar pravokutnika
  const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
  text.setAttribute("x", x + width / 2);
  text.setAttribute("y", y + height / 2);
  text.setAttribute("text-anchor", "middle");
  text.setAttribute("dominant-baseline", "middle");
  text.setAttribute("fill", "white");
  text.setAttribute("font-size", "20");
  text.setAttribute("font-family", "Source Code Pro, monospace");

  const boldPart = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
  boldPart.setAttribute("font-weight", "bold");
  boldPart.textContent = title;

  const suffixPart = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
  suffixPart.setAttribute("font-weight", "normal");
  suffixPart.textContent = " - Pinout";

  text.appendChild(boldPart);
  text.appendChild(suffixPart);

  group.appendChild(path);
  group.appendChild(text);
  graphicsLayer.appendChild(group);
}














function downloadCurrentViewportAsSVG() {
  if (!panZoomInstance) return alert("SVG nije učitan!");

  // Dohvati trenutni viewBox i dimenzije iz svg-pan-zoom
  const sizes = panZoomInstance.getSizes();

  // Dodaj 5% paddinga oko viewBox-a
  const paddingFactor = 0.05;

  let x = sizes.viewBox.x;
  let y = sizes.viewBox.y;
  let width = sizes.viewBox.width;
  let height = sizes.viewBox.height;

  const extraW = width * paddingFactor;
  const extraH = height * paddingFactor;

  x -= extraW / 2;
  y -= extraH / 2;
  width += extraW;
  height += extraH;

  const viewBox = `${x} ${y} ${width} ${height}`;

  // Sastavi novi SVG s tim viewBoxom
  const exportSVG = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  exportSVG.setAttribute("xmlns", "http://www.w3.org/2000/svg");
  exportSVG.setAttribute("viewBox", viewBox);
  exportSVG.setAttribute("width", sizes.width);
  exportSVG.setAttribute("height", sizes.height);
  exportSVG.setAttribute("preserveAspectRatio", "xMidYMid meet");

  const graphicsClone = graphicsLayer.cloneNode(true);
  const userClone = userLayer.cloneNode(true);

  exportSVG.appendChild(graphicsClone);
  exportSVG.appendChild(userClone);

  const svgString = new XMLSerializer().serializeToString(exportSVG);
  const blob = new Blob([svgString], { type: "image/svg+xml" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "viewport.svg";
  a.click();
  URL.revokeObjectURL(url);
}



</script>

</body>
</html>
