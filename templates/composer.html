<!DOCTYPE html>
<html>
<head>
  <title>SVG Composer – A4 Layout</title>
  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
  <style>
    body {
      font-family: 'Source Code Pro', monospace;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #navbar {
      background: #333;
      color: white;
      padding: 10px 20px;
      display: flex;
      gap: 20px;
      align-items: center;
    }

    #navbar a {
      color: white;
      text-decoration: none;
      font-weight: bold;
      font-size: 0.95rem;
    }

    #navbar a.active {
      background-color: #555;
      padding: 6px 12px;
      border-radius: 5px;
    }

    #composer-toolbar {
      background: #f4f4f4;
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      border-bottom: 1px solid #ccc;
    }

    #composer-area {
      flex: 1;
      background: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    .paper-wrapper {
      width: 1122px;
      height: 794px;
      box-shadow: 0 0 0 2px #999;
      background: white;
      position: relative;
    }

    .paper-wrapper svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 1122px;
      height: 794px;
    }

    #graphics-svg {
      pointer-events: auto;
    }

    #user-svg {
      pointer-events: none;
    }
  </style>
</head>
<body>

<div id="navbar">
  <a href="/kicad">KiCad Layers</a>
  <a href="/editor-upload">SVG Pin Editor</a>
  <a href="/composer" class="active">SVG to PDF</a>
</div>

<div id="composer-toolbar">
  <input type="file" id="svg-upload" accept=".svg">
  <button onclick="rotateSVG()">Rotiraj +90°</button>
  <button onclick="zoomIn()">Povećaj</button>
  <button onclick="zoomOut()">Smanji</button>

  <button onclick="downloadA4SVG()">Export A4 SVG</button>
  <button id="switch-layer">Layer: GRAPHICS</button>
  <input type="text" id="title-input" placeholder="Upiši naziv (npr. DasDuino Core)" style="flex: 1; max-width: 300px;">
  <button onclick="addTitleBox()">Dodaj naslov</button>
</div>

<div id="composer-area">
  <div class="paper-wrapper">
    <svg id="graphics-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1122 794">
      <g id="graphics-layer"></g>
    </svg>
    <svg id="user-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1122 794">
      <g id="user-layer" transform="rotate(0 561 397)"></g>
    </svg>
  </div>
</div>

<script>
  const A4_WIDTH = 1122;
  const A4_HEIGHT = 794;

  const graphicsSVG = document.getElementById("graphics-svg");
  const graphicsLayer = document.getElementById("graphics-layer");
  const userSVG = document.getElementById("user-svg");
  const userLayer = document.getElementById("user-layer");
  const switchButton = document.getElementById("switch-layer");

  let currentLayer = "graphics";
  let currentRotation = 0;
  let panZoomInstance = null;
  let isDragging = false;
  let dragStart = { x: 0, y: 0 };
  let translate = { x: 0, y: 0 };

  let scaleFactor = 1;


  function updateLayerMode() {
    if (currentLayer === "graphics") {
      graphicsSVG.style.pointerEvents = "auto";
      userSVG.style.pointerEvents = "none";
      switchButton.textContent = "Layer: GRAPHICS";
    } else {
      graphicsSVG.style.pointerEvents = "none";
      userSVG.style.pointerEvents = "auto";
      switchButton.textContent = "Layer: USER";
    }
  }

  switchButton.addEventListener("click", () => {
    currentLayer = currentLayer === "graphics" ? "user" : "graphics";
    updateLayerMode();
  });

  updateLayerMode();

  document.getElementById('svg-upload').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file || !file.name.endsWith('.svg')) return;

    const reader = new FileReader();
    reader.onload = function(event) {
      const tempContainer = document.createElement("div");
      tempContainer.innerHTML = event.target.result;
      const incomingSVG = tempContainer.querySelector("svg");
      if (!incomingSVG) return;

      userLayer.innerHTML = "";

      while (incomingSVG.childNodes.length > 0) {
        userLayer.appendChild(incomingSVG.childNodes[0]);
      }

      // Reset transform
      currentRotation = 0;
      translate = { x: 0, y: 0 };
      updateUserLayerTransform();
    };

    reader.readAsText(file);
  });

  function rotateSVG() {
    currentRotation = (currentRotation + 90) % 360;
    updateUserLayerTransform();
  }

  function zoomIn() {
    scaleFactor *= 1.1;
    updateUserLayerTransform();
  }

  function zoomOut() {
    scaleFactor /= 1.1;
    updateUserLayerTransform();
  }



  function updateUserLayerTransform() {
    const cx = A4_WIDTH / 2;
    const cy = A4_HEIGHT / 2;

    userLayer.setAttribute(
      "transform",
      `translate(${translate.x} ${translate.y}) rotate(${currentRotation} ${cx} ${cy}) scale(${scaleFactor})`
    );
  }


  // Drag logic
  userLayer.addEventListener("mousedown", e => {
    if (currentLayer !== "user") return;
    isDragging = true;
    dragStart = { x: e.clientX, y: e.clientY };
  });

  window.addEventListener("mousemove", e => {
    if (!isDragging) return;
    const dx = e.clientX - dragStart.x;
    const dy = e.clientY - dragStart.y;
    dragStart = { x: e.clientX, y: e.clientY };
    translate.x += dx;
    translate.y += dy;
    updateUserLayerTransform();
  });

  window.addEventListener("mouseup", () => {
    isDragging = false;
  });

  function addTitleBox() {
    const titleInput = document.getElementById("title-input");
    const rawText = titleInput.value.trim();
    if (!rawText) return;

    const title = rawText.toUpperCase();
    const group = document.createElementNS("http://www.w3.org/2000/svg", "g");

    const x = 30;
    const y = 30;
    const width = 800;
    const height = 50;
    const cut = 10;

    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", `
      M${x},${y} 
      H${x + width} 
      V${y + height} 
      H${x + cut} 
      L${x},${y + height - cut} 
      Z
    `);
    path.setAttribute("fill", "#500B76");

    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
    text.setAttribute("x", x + width / 2);
    text.setAttribute("y", y + height / 2);
    text.setAttribute("text-anchor", "middle");
    text.setAttribute("dominant-baseline", "middle");
    text.setAttribute("fill", "white");
    text.setAttribute("font-size", "20");
    text.setAttribute("font-family", "Source Code Pro, monospace");

    const boldPart = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
    boldPart.setAttribute("font-weight", "bold");
    boldPart.textContent = title;

    const suffixPart = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
    suffixPart.setAttribute("font-weight", "normal");
    suffixPart.textContent = " - Pinout";

    text.appendChild(boldPart);
    text.appendChild(suffixPart);
    group.appendChild(path);
    group.appendChild(text);
    graphicsLayer.appendChild(group);
  }

  function downloadA4SVG() {
    const exportSVG = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    exportSVG.setAttribute("xmlns", "http://www.w3.org/2000/svg");
    exportSVG.setAttribute("viewBox", `0 0 ${A4_WIDTH} ${A4_HEIGHT}`);
    exportSVG.setAttribute("width", A4_WIDTH);
    exportSVG.setAttribute("height", A4_HEIGHT);
    exportSVG.setAttribute("preserveAspectRatio", "xMidYMid meet");

    const graphicsClone = graphicsLayer.cloneNode(true);
    const userClone = userLayer.cloneNode(true);

    exportSVG.appendChild(graphicsClone);
    exportSVG.appendChild(userClone);

    const svgString = new XMLSerializer().serializeToString(exportSVG);
    const blob = new Blob([svgString], { type: "image/svg+xml" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "a4_export.svg";
    a.click();
    URL.revokeObjectURL(url);
  }
</script>

</body>
</html>
