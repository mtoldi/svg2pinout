<!DOCTYPE html>
<html>
<head>
  <title>SKU Pin Label Editor</title>
  <style>
    body { font-family: sans-serif; display: flex; }
    #editor-panel {
      width: 250px;
      border-right: 1px solid #ccc;
      padding: 1rem;
      overflow-y: auto;
    }
    #svg-container {
      flex-grow: 1;
      border: 1px solid #ccc;
      margin: 1rem;
      width: 100%;
      height: 90vh;
    }
    .hex-label {
      cursor: pointer;
      text-anchor: middle;
      dominant-baseline: middle;
      fill: white;
    }
    .pin-item {
      margin-bottom: 0.5rem;
    }
    .pin-item.selected {
      background: #eee;
    }
    circle.pin-highlight {
      stroke: rgb(0, 255, 76);
      stroke-width: 0.5;
      fill: none;
    }
    .label-input {
      display: block;
      margin-top: 0.2rem;
      width: 90%;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>

  <div id="editor-panel">
    <h3>Pinovi</h3>
    <div id="pin-list"></div>
  </div>

  <div id="svg-container"></div>

  <script>
    const container = document.getElementById("svg-container");
    const pinList = document.getElementById("pin-list");
    let overlay = null;
    let pinMap = new Map();
    let selectedPinId = null;
    let highlightCircle = null;

    fetch("/svg/sku.svg")
      .then(res => res.text())
      .then(svgText => {
        container.innerHTML = svgText;
        initEditor();
      });

    function initEditor() {
      const svg = container.querySelector("svg");
      const viewport = svg.querySelector(".svg-pan-zoom_viewport") || svg;

      overlay = document.createElementNS("http://www.w3.org/2000/svg", "g");
      overlay.setAttribute("id", "label-overlay");
      viewport.appendChild(overlay);

      const pinCircles = [...svg.querySelectorAll("circle")].filter((c, i) => {
        const fill = (c.getAttribute("fill") || "").toLowerCase();
        const stroke = (c.getAttribute("stroke") || "").toLowerCase();
        const r = parseFloat(c.getAttribute("r"));
        return (fill === "#cccccc" || fill === "gray") && stroke === "none" && Math.abs(r - 0.5) < 0.2;
      });

      pinCircles.forEach((pin, idx) => {
        const cx = parseFloat(pin.getAttribute("cx"));
        const cy = parseFloat(pin.getAttribute("cy"));
        const pinId = `P${idx + 1}`;

        pinMap.set(pinId, { cx, cy });

        const item = document.createElement("div");
        item.className = "pin-item";
        item.innerHTML = `
          <strong>${pinId}</strong><br>
          <button onclick="placeLabel('${pinId}', 'N')">N</button>
          <button onclick="placeLabel('${pinId}', 'E')">E</button>
          <button onclick="placeLabel('${pinId}', 'S')">S</button>
          <button onclick="placeLabel('${pinId}', 'W')">W</button>
          <input class="label-input" id="${pinId}-input" placeholder="Label text" />
        `;

        item.addEventListener("click", () => {
          document.querySelectorAll('.pin-item').forEach(el => el.classList.remove('selected'));
          item.classList.add("selected");
          selectedPinId = pinId;

          if (highlightCircle) highlightCircle.remove();
          highlightCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          highlightCircle.setAttribute("cx", cx);
          highlightCircle.setAttribute("cy", cy);
          highlightCircle.setAttribute("r", 1);
          highlightCircle.classList.add("pin-highlight");
          overlay.appendChild(highlightCircle);
        });

        pinList.appendChild(item);
      });
    }

    function placeLabel(pinId, direction) {
      if (pinId !== selectedPinId) return;
      const { cx, cy } = pinMap.get(pinId);
      const inputVal = document.getElementById(`${pinId}-input`).value;
      const baseSize = 1.3;
      const spacing = 6;
      const textLength = inputVal.length;
      const textMargin = 0.4;

      let dx = 0, dy = 0;
      let labelX = cx, labelY = cy;
      let sizeX = baseSize, sizeY = baseSize;

      switch (direction) {
        case 'E':
          sizeX += textLength * 0.4;
          dx = spacing;
          labelX = cx + dx + sizeX / 2;
          break;
        case 'W':
          sizeX += textLength * 0.4;
          dx = -spacing;
          labelX = cx + dx - sizeX / 2;
          break;
        case 'N':
          sizeY += textLength * 0.3;
          dy = -spacing;
          labelY = cy + dy - sizeY / 2;
          break;
        case 'S':
          sizeY += textLength * 0.3;
          dy = spacing;
          labelY = cy + dy + sizeY / 2;
          break;
      }

      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", cx);
      line.setAttribute("y1", cy);
      line.setAttribute("x2", labelX);
      line.setAttribute("y2", labelY);
      line.setAttribute("stroke", "black");
      line.setAttribute("stroke-width", "0.2");

      const hex = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
      const points = Array.from({ length: 5 }, (_, i) => {
        const angle = Math.PI / 3 * i;
        const x = labelX + sizeX * Math.cos(angle);
        const y = labelY + sizeY * Math.sin(angle);
        return `${x},${y}`;
      }).join(" ");
      hex.setAttribute("points", points);
      hex.setAttribute("fill", "#800080");
      hex.setAttribute("stroke", "black");
      hex.setAttribute("stroke-width", "0.2");

      const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
      text.setAttribute("x", labelX);
      text.setAttribute("y", labelY + 0.25);
      text.setAttribute("class", "hex-label");
      text.setAttribute("font-size", "1.5px");
      text.textContent = inputVal;

      overlay.appendChild(line);
      overlay.appendChild(hex);
      overlay.appendChild(text);
    }
  </script>
</body>
</html>
