<!DOCTYPE html>
<html>
<head>
  <title>SKU Pin Label Editor</title>
  <style>
    body { font-family: sans-serif; display: flex; }
    #editor-panel {
      height: 100vh;
      width: 250px;
      border-right: 1px solid #ccc;
      padding: 1rem;
      overflow-y: auto;
    }
    #svg-container {
      flex-grow: 1;
      border: 1px solid #ccc;
      margin: 1rem;
      height: 90vh;
    }
    .hex-label {
      cursor: pointer;
      text-anchor: middle;
      dominant-baseline: middle;
      fill: white;
    }
    .pin-item {
      margin-bottom: 0.5rem;
    }
    .pin-item.selected {
      background: #9bbec9;
    }
    circle.pin-highlight {
      stroke: rgb(0, 240, 255);
      stroke-width: 0.5;
      fill: none;
    }
    .label-input {
      display: block;
      margin-top: 0.2rem;
      width: 90%;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>

  <div id="editor-panel">
    <h3>Pinovi</h3>
    <div id="pin-list"></div>
  </div>

  <div id="svg-container"></div>

  <script>
    const container = document.getElementById("svg-container");
    const pinList = document.getElementById("pin-list");
    let overlay = null;
    let pinMap = new Map();
    let selectedPinId = null;
    let highlightCircle = null;

    fetch("/svg/sku.svg")
      .then(res => res.text())
      .then(svgText => {
        container.innerHTML = svgText;
        initEditor();
      });

    function initEditor() {
      const svg = container.querySelector("svg");
      const viewport = svg.querySelector(".svg-pan-zoom_viewport") || svg;

      overlay = document.createElementNS("http://www.w3.org/2000/svg", "g");
      overlay.setAttribute("id", "label-overlay");
      viewport.appendChild(overlay);

      const pinCircles = [...svg.querySelectorAll("circle")].filter(c => {
        const fill = (c.getAttribute("fill") || "").toLowerCase();
        const stroke = (c.getAttribute("stroke") || "").toLowerCase();
        const r = parseFloat(c.getAttribute("r"));
        return (fill === "#cccccc" || fill === "gray") && stroke === "none" && r==0.5;
      });

      pinCircles.forEach((pin, idx) => {
        const cx = parseFloat(pin.getAttribute("cx"));
        const cy = parseFloat(pin.getAttribute("cy"));
        const pinId = `P${idx + 1}`;
        pinMap.set(pinId, { cx, cy, labels: [] });

        const item = document.createElement("div");
        item.className = "pin-item";
        item.innerHTML = `
          <strong>${pinId}</strong><br>
          <button onclick="placeAllLabels('${pinId}', 'N')">N</button>
          <button onclick="placeAllLabels('${pinId}', 'E')">E</button>
          <button onclick="placeAllLabels('${pinId}', 'S')">S</button>
          <button onclick="placeAllLabels('${pinId}', 'W')">W</button>
          <button onclick="addLabel('${pinId}')">+</button>
          <div id="${pinId}-labels">
            <input class="label-input" id="${pinId}-input-0" placeholder="Label text" />
          </div>
        `;

        item.addEventListener("click", () => {
          document.querySelectorAll('.pin-item').forEach(el => el.classList.remove('selected'));
          item.classList.add("selected");
          selectedPinId = pinId;

          if (highlightCircle) highlightCircle.remove();
          highlightCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          highlightCircle.setAttribute("cx", cx);
          highlightCircle.setAttribute("cy", cy);
          highlightCircle.setAttribute("r", 1);
          highlightCircle.classList.add("pin-highlight");
          overlay.appendChild(highlightCircle);
        });

        pinList.appendChild(item);
      });
    }

    function addLabel(pinId) {
      const pin = pinMap.get(pinId);
      const idx = pin.labels.length + 1;

      const container = document.getElementById(`${pinId}-labels`);
      const input = document.createElement("input");
      input.className = "label-input";
      input.id = `${pinId}-input-${idx}`;
      input.placeholder = "Label text";
      container.appendChild(input);

      pin.labels.push({ index: idx });
    }

    function placeAllLabels(pinId, direction) {
      const pin = pinMap.get(pinId);
      const labelCount = document.querySelectorAll(`#${pinId}-labels input`).length;

      for (let i = 0; i < labelCount; i++) {
        placeLabel(pinId, direction, i);
      }
    }

    function placeLabel(pinId, direction, labelIndex = 0) {
      if (pinId !== selectedPinId) return;
      const pin = pinMap.get(pinId);
      let anchorX = pin.cx, anchorY = pin.cy;

      if (labelIndex > 0) {
        const prev = overlay.lastPlacedLabels?.[pinId]?.[labelIndex - 1];
        if (prev) {
          anchorX = prev.endX;
          anchorY = prev.endY;
        }
      }


      const inputVal = document.getElementById(`${pinId}-input-${labelIndex}`).value;
      const fontSize = 1.3;
      const padding = 0.8;
      const spacing = (labelIndex === 0) ? 5 : 2;

      const tempText = document.createElementNS("http://www.w3.org/2000/svg", "text");
      tempText.setAttribute("x", -9999);
      tempText.setAttribute("y", -9999);
      tempText.setAttribute("font-size", `${fontSize}px`);
      tempText.textContent = inputVal;
      overlay.appendChild(tempText);
      const textWidth = tempText.getBBox().width;
      overlay.removeChild(tempText);

      const bodyWidth = textWidth + padding * 3;
      const bodyHeight = fontSize + padding;
      const inset = bodyHeight * 0.3;

      let polyPoints = "";
      let labelX = anchorX, labelY = anchorY;
      let lineX = anchorX, lineY = anchorY;
      let rotate = null;

      let baseX, baseY;

      switch (direction) {
        case 'E':
          baseX = anchorX + spacing;
          baseY = anchorY - bodyHeight / 2;
          labelX = baseX + bodyWidth / 2;
          labelY = anchorY;
          lineX = baseX;
          lineY = anchorY;
          break;
        case 'W':
          baseX = anchorX - spacing - bodyWidth;
          baseY = anchorY - bodyHeight / 2;
          labelX = baseX + bodyWidth / 2;
          labelY = anchorY;
          lineX = baseX + bodyWidth;
          lineY = anchorY;
          break;
        case 'N':
          baseX = anchorX - bodyWidth / 2;
          baseY = anchorY - spacing - bodyHeight;
          labelX = anchorX;
          labelY = baseY + bodyHeight / 2;
          lineX = anchorX;
          lineY = baseY + bodyHeight;
          rotate = `rotate(-90 ${labelX} ${labelY})`;
          break;
        case 'S':
          baseX = anchorX - bodyWidth / 2;
          baseY = anchorY + spacing;
          labelX = anchorX;
          labelY = baseY + bodyHeight / 2;
          lineX = anchorX;
          lineY = baseY;
          rotate = `rotate(-90 ${labelX} ${labelY})`;
          break;
      }

      polyPoints = [
        [baseX + inset, baseY],
        [baseX + bodyWidth - inset, baseY],
        [baseX + bodyWidth, baseY + bodyHeight / 2],
        [baseX + bodyWidth - inset, baseY + bodyHeight],
        [baseX + inset, baseY + bodyHeight],
        [baseX, baseY + bodyHeight / 2]
      ];

      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", anchorX);
      line.setAttribute("y1", anchorY);
      line.setAttribute("x2", lineX);
      line.setAttribute("y2", lineY);
      line.setAttribute("stroke", "black");
      line.setAttribute("stroke-width", "0.2");

      const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
      polygon.setAttribute("points", polyPoints.map(p => p.join(",")).join(" "));
      polygon.setAttribute("fill", "#800080");
      polygon.setAttribute("stroke", "black");
      polygon.setAttribute("stroke-width", "0.2");

      const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
      text.setAttribute("x", labelX);
      text.setAttribute("y", labelY + fontSize * 0.1);
      text.setAttribute("class", "hex-label");
      text.setAttribute("font-size", `${fontSize}px`);
      text.textContent = inputVal;

      if (rotate) {
        polygon.setAttribute("transform", rotate);
        text.setAttribute("transform", rotate);
      }

      overlay.appendChild(line);
      overlay.appendChild(polygon);
      overlay.appendChild(text);

      if (!overlay.lastPlacedLabels) overlay.lastPlacedLabels = {};
      if (!overlay.lastPlacedLabels[pinId]) overlay.lastPlacedLabels[pinId] = [];
      let endPoint;
      switch (direction) {
        case 'E': endPoint = polyPoints[2]; break;
        case 'W': endPoint = polyPoints[5]; break;
        case 'N': endPoint = polyPoints[0]; break;
        case 'S': endPoint = polyPoints[3]; break;
      }
      overlay.lastPlacedLabels[pinId][labelIndex] = { endX: endPoint[0], endY: endPoint[1] };

    }
  </script>
</body>
</html>
