<!DOCTYPE html>
<html>
<head>
  <title>SKU Pin Label Editor</title>
  <style>
    body { font-family: sans-serif; display: flex; }
    #editor-panel {
      width: 250px;
      border-right: 1px solid #ccc;
      padding: 1rem;
      overflow-y: auto;
    }
    #svg-container {
      flex-grow: 1;
      border: 1px solid #ccc;
      margin: 1rem;
      height: 90vh;
    }
    .hex-label {
      cursor: pointer;
      text-anchor: middle;
      dominant-baseline: middle;
      fill: white;
    }
    .pin-item {
      margin-bottom: 0.5rem;
    }
    .pin-item.selected {
      background: #eee;
    }
    circle.pin-highlight {
      stroke: rgb(0, 240, 255);
      stroke-width: 0.5;
      fill: none;
    }
    .label-input {
      display: block;
      margin-top: 0.2rem;
      width: 90%;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>

  <div id="editor-panel">
    <h3>Pinovi</h3>
    <div id="pin-list"></div>
  </div>

  <div id="svg-container"></div>

  <script>
    const container = document.getElementById("svg-container");
    const pinList = document.getElementById("pin-list");
    let overlay = null;
    let pinMap = new Map();
    let selectedPinId = null;
    let highlightCircle = null;

    fetch("/svg/sku.svg")
      .then(res => res.text())
      .then(svgText => {
        container.innerHTML = svgText;
        initEditor();
      });

    function initEditor() {
      const svg = container.querySelector("svg");
      const viewport = svg.querySelector(".svg-pan-zoom_viewport") || svg;

      overlay = document.createElementNS("http://www.w3.org/2000/svg", "g");
      overlay.setAttribute("id", "label-overlay");
      viewport.appendChild(overlay);

      const pinCircles = [...svg.querySelectorAll("circle")].filter(c => {
        const fill = (c.getAttribute("fill") || "").toLowerCase();
        const stroke = (c.getAttribute("stroke") || "").toLowerCase();
        const r = parseFloat(c.getAttribute("r"));
        return (fill === "#cccccc" || fill === "gray") && stroke === "none" && Math.abs(r - 0.5) < 0.2;
      });

      pinCircles.forEach((pin, idx) => {
        const cx = parseFloat(pin.getAttribute("cx"));
        const cy = parseFloat(pin.getAttribute("cy"));
        const pinId = `P${idx + 1}`;
        pinMap.set(pinId, { cx, cy });

        const item = document.createElement("div");
        item.className = "pin-item";
        item.innerHTML = `
          <strong>${pinId}</strong><br>
          <button onclick="placeLabel('${pinId}', 'N')">N</button>
          <button onclick="placeLabel('${pinId}', 'E')">E</button>
          <button onclick="placeLabel('${pinId}', 'S')">S</button>
          <button onclick="placeLabel('${pinId}', 'W')">W</button>
          <input class="label-input" id="${pinId}-input" placeholder="Label text" />
        `;

        item.addEventListener("click", () => {
          document.querySelectorAll('.pin-item').forEach(el => el.classList.remove('selected'));
          item.classList.add("selected");
          selectedPinId = pinId;

          if (highlightCircle) highlightCircle.remove();
          highlightCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          highlightCircle.setAttribute("cx", cx);
          highlightCircle.setAttribute("cy", cy);
          highlightCircle.setAttribute("r", 1);
          highlightCircle.classList.add("pin-highlight");
          overlay.appendChild(highlightCircle);
        });

        pinList.appendChild(item);
      });
    }

function placeLabel(pinId, direction) {
  if (pinId !== selectedPinId) return;
  const { cx, cy } = pinMap.get(pinId);
  const inputVal = document.getElementById(`${pinId}-input`).value;

  const fontSize = 1.3;
  const padding = 0.8;
  const spacing = 6;

  // privremeni text element da izmjerimo točnu širinu
  const tempText = document.createElementNS("http://www.w3.org/2000/svg", "text");
  tempText.setAttribute("x", -9999);
  tempText.setAttribute("y", -9999);
  tempText.setAttribute("font-size", `${fontSize}px`);
  tempText.textContent = inputVal;
  overlay.appendChild(tempText);
  const textWidth = tempText.getBBox().width;
  const textHeight = tempText.getBBox().height;
  overlay.removeChild(tempText);

  const rectWidth = textWidth + padding * 3;
  const rectHeight = fontSize + padding;

  let rectX, rectY, labelX, labelY, lineX, lineY;
  let rotate = null;

  switch (direction) {
    case 'E':
      rectX = cx + spacing;
      rectY = cy - rectHeight / 2;
      labelX = rectX + rectWidth / 2;
      labelY = cy;
      lineX = rectX;
      lineY = cy;
      break;
    case 'W':
      rectX = cx - spacing - rectWidth;
      rectY = cy - rectHeight / 2;
      labelX = rectX + rectWidth / 2;
      labelY = cy;
      lineX = rectX + rectWidth;
      lineY = cy;
      break;
    case 'N':
      rectX = cx - rectWidth / 2;
      rectY = cy - spacing - rectHeight;
      labelX = cx;
      labelY = rectY + rectHeight / 2;
      lineX = cx;
      lineY = rectY + rectHeight;
      rotate = `rotate(-90 ${labelX} ${labelY})`;
      break;
    case 'S':
      rectX = cx - rectWidth / 2;
      rectY = cy + spacing;
      labelX = cx;
      labelY = rectY + rectHeight / 2;
      lineX = cx;
      lineY = rectY;
      rotate = `rotate(-90 ${labelX} ${labelY})`;
      break;
  }

  const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
  line.setAttribute("x1", cx);
  line.setAttribute("y1", cy);
  line.setAttribute("x2", lineX);
  line.setAttribute("y2", lineY);
  line.setAttribute("stroke", "black");
  line.setAttribute("stroke-width", "0.2");

  const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
  rect.setAttribute("x", rectX);
  rect.setAttribute("y", rectY);
  rect.setAttribute("width", rectWidth);
  rect.setAttribute("height", rectHeight);
  rect.setAttribute("fill", "#800080");
  rect.setAttribute("stroke", "black");
  rect.setAttribute("stroke-width", "0.2");
  rect.setAttribute("rx", "0.5");

  const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
  text.setAttribute("x", labelX);
  text.setAttribute("y", labelY + fontSize * 0.1);
  text.setAttribute("class", "hex-label");
  text.setAttribute("font-size", `${fontSize}px`);
  text.textContent = inputVal;

  if (rotate) {
    rect.setAttribute("transform", rotate);
    text.setAttribute("transform", rotate);
  }

  overlay.appendChild(line);
  overlay.appendChild(rect);
  overlay.appendChild(text);
}

  </script>
</body>
</html>
