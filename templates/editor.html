<!DOCTYPE html>
<html>
<head>
  <title>SKU Pin Label Editor</title>
  <style>
    body { font-family: sans-serif; display: flex; }
    #editor-panel {
      width: 250px;
      border-right: 1px solid #ccc;
      padding: 1rem;
    }
    #svg-container {
      flex-grow: 1;
      border: 1px solid #ccc;
      margin: 1rem;
      width: 100%;
      height: 90vh;
    }
    .hex-label {
      cursor: pointer;
      font-size: 4px;
      text-anchor: middle;
      dominant-baseline: middle;
      fill: white;
    }
    .pin-item {
      margin-bottom: 0.5rem;
    }
    .pin-item.selected {
      background: #eee;
    }
    circle.pin-highlight {
      stroke: rgb(0, 255, 76);
      stroke-width: 0.5;
      fill: none;
    }
  </style>
</head>
<body>

  <div id="editor-panel">
    <h3>Pinovi</h3>
    <div id="pin-list"></div>
  </div>

  <div id="svg-container"></div>

  <script>
    const container = document.getElementById("svg-container");
    const pinList = document.getElementById("pin-list");
    let overlay = null;
    let pinMap = new Map();
    let selectedPinId = null;
    let highlightCircle = null;

    fetch("/svg/sku.svg")
      .then(res => res.text())
      .then(svgText => {
        container.innerHTML = svgText;
        initEditor();
      });

    function initEditor() {
      const svg = container.querySelector("svg");
      const viewport = svg.querySelector(".svg-pan-zoom_viewport") || svg;

      overlay = document.createElementNS("http://www.w3.org/2000/svg", "g");
      overlay.setAttribute("id", "label-overlay");
      viewport.appendChild(overlay);

      const pinCircles = [...svg.querySelectorAll("circle")].filter((c, i) => {
        const fill = (c.getAttribute("fill") || "").toLowerCase();
        const stroke = (c.getAttribute("stroke") || "").toLowerCase();
        const r = parseFloat(c.getAttribute("r"));
        return (fill === "#cccccc" || fill === "gray") && stroke === "none" && Math.abs(r - 0.5) < 0.2;
      });

      pinCircles.forEach((pin, idx) => {
        const cx = parseFloat(pin.getAttribute("cx"));
        const cy = parseFloat(pin.getAttribute("cy"));
        const pinId = `P${idx + 1}`;

        pinMap.set(pinId, { cx, cy });

        const item = document.createElement("div");
        item.className = "pin-item";
        item.innerHTML = `
          <strong>${pinId}</strong><br>
          <button onclick="placeLabel('${pinId}', 'N')">N</button>
          <button onclick="placeLabel('${pinId}', 'E')">E</button>
          <button onclick="placeLabel('${pinId}', 'S')">S</button>
          <button onclick="placeLabel('${pinId}', 'W')">W</button>
        `;

        item.addEventListener("click", () => {
          document.querySelectorAll('.pin-item').forEach(el => el.classList.remove('selected'));
          item.classList.add("selected");
          selectedPinId = pinId;

          if (highlightCircle) highlightCircle.remove();
          highlightCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          highlightCircle.setAttribute("cx", cx);
          highlightCircle.setAttribute("cy", cy);
          highlightCircle.setAttribute("r", 1);
          highlightCircle.classList.add("pin-highlight");
          overlay.appendChild(highlightCircle);
        });

        pinList.appendChild(item);
      });
    }

    function placeLabel(pinId, direction) {
      if (pinId !== selectedPinId) return;
      const { cx, cy } = pinMap.get(pinId);
      const offset = 6; // duÅ¾a linija
      let dx = 0, dy = 0;

      switch (direction) {
        case 'N': dy = -offset; break;
        case 'S': dy = offset; break;
        case 'E': dx = offset; break;
        case 'W': dx = -offset; break;
      }

      const labelX = cx + dx;
      const labelY = cy + dy;

      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", cx);
      line.setAttribute("y1", cy);
      line.setAttribute("x2", labelX);
      line.setAttribute("y2", labelY);
      line.setAttribute("stroke", "#800080");
      line.setAttribute("stroke-width", "0.2");

      const hex = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
      const size = 1.3;
      const points = Array.from({ length: 6 }, (_, i) => {
        const angle = Math.PI / 3 * i;
        const x = labelX + size * Math.cos(angle);
        const y = labelY + size * Math.sin(angle);
        return `${x},${y}`;
      }).join(" ");
      hex.setAttribute("points", points);
      hex.setAttribute("fill", "#800080");

      const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
      text.setAttribute("x", labelX);
      text.setAttribute("y", labelY + 0.1);
      text.setAttribute("class", "hex-label");
      text.textContent = "";

      text.addEventListener("click", () => {
        const newText = prompt("Unesi labelu:", text.textContent);
        if (newText !== null) {
          text.textContent = newText;
          const len = newText.length;
          const newSize = 1 + len * 0.3;
          const newPoints = Array.from({ length: 6 }, (_, i) => {
            const angle = Math.PI / 3 * i;
            const x = labelX + newSize * Math.cos(angle);
            const y = labelY + newSize * Math.sin(angle);
            return `${x},${y}`;
          }).join(" ");
          hex.setAttribute("points", newPoints);
        }
      });

      overlay.appendChild(line);
      overlay.appendChild(hex);
      overlay.appendChild(text);
    }
  </script>
</body>
</html>
